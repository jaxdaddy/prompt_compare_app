# Prompt Compare Application

This application compares two different prompts for generating financial news summaries and evaluates them based on several metrics.

## Usage

1.  **Prepare Files:**
    *   Place your data files in the `files/` directory. Supported types include:
        *   `COR_Movers_YYYY-MM-DD.pdf`
        *   `COR_Daily_Top_And_Bottom_YYYY-MM-DD.pdf`
        *   `COY_Movers_YYYY-MM-DD.pdf`
        *   `COY_Daily_Top_And_Bottom_YYYY-MM-DD.pdf`
        *   `POR_Movers_YYYY-MM-DD.pdf`
        *   `POR_Daily_Top_And_Bottom_YYYY-MM-DD.pdf`
        *   `POY_Movers_YYYY-MM-DD.pdf`
        *   `POY_Daily_Top_And_Bottom_YYYY-MM-DD.pdf`
    *   Ensure the primer file `options_primer.pdf` is also in `files/`.
    *   The application uses prompt files (e.g., `prompt_cor_movers.txt`) located in `files/`, configured via `prompts.yaml`.

2.  **API Keys & Configuration:**
    *   Create a `.env` file in the project root.
    *   Add your Gemini API key: `GEMINI_API_KEY=your_gemini_api_key_here` (Get it from [Google AI Studio](https://aistudio.google.com/)).
    *   Add your NewsAPI key: `NEWSAPI_KEY=your_newsapi_key_here` (Get a free key from [https://newsapi.org/](https://newsapi.org/)).
    *   (Optional) Set default debug mode: `DEBUG=True`.

3.  **Install Dependencies:**
    *   `pip install -r requirements.txt`

4.  **Run the Application:**
    *   Standard run: `python app.py`
    *   Debug mode (limits news fetching to 2 tickers): `python app.py --debug`

## Features

*   **Automatic File Selection & Processing:** The application iterates through file types defined in `prompts.yaml` (e.g., COR, COY, POR, POY). For each type, it automatically selects the newest PDF file from the `files/` directory based on the date in the filename.
    *   Processed files are automatically moved to a `files/completed/` directory to prevent re-processing.

*   **News Fetching with NewsAPI:** The application uses NewsAPI exclusively to fetch recent financial news for the companies identified in the COR file.

*   **Improved Relevance Ranking:** The relevance of generated summaries is now calculated using a combination of:
    *   **LLM Relevance Score:** A qualitative score (1-10) and justification provided by the Gemini LLM.
    *   **Cosine Similarity:** A quantitative measure of semantic similarity between the summary and the news articles, calculated using `sentence-transformers`.
    *   A final combined relevance score is derived from these two metrics.

*   **Automated Summary Evaluation:** The application includes a `summary_evaluator` module that provides a detailed analysis of the generated summaries based on a set of predefined metrics. These metrics include:
    *   **Relevance:** Metric Alignment, Data Relevance, and Primer Consistency.
    *   **Readability:** Structure, Clarity, and Writing Quality.
    *   A final **Composite Score** is calculated based on a weighted average of the relevance and readability scores.

*   **Debug Mode:**
    *   Run with `python app.py --debug` or set `DEBUG=True` in `.env`.
    *   Limits news fetching to the first two tickers per file to save API calls.
    *   Provides a "Using prompt file..." indicator in the console.

## Database Viewer (`db_viewer.py`)

This module provides a web-based interface (using Shiny for Python) to visualize and compare the metrics generated by `app.py` and stored in `prompt_compare.db`.

### Features

*   **Tabbed Interface:** The UI is organized into two tabs for easy navigation:
    *   **Comparison View:** Displays a side-by-side comparison of all key metrics, including reading level, word count, relevance scores, and the new detailed evaluation scores from the `summary_evaluator` module.
    *   **Metrics Graph View:** Shows interactive line charts displaying the trend of selected metrics over time, including all the new evaluation scores.
*   **Run History:** View a list of all previous application runs in the sidebar.
*   **Data Refresh:** A "Refresh Data" button allows you to load the latest runs from the database without restarting the application.
*   **File Paths:** The "Comparison View" also displays the file names and paths for the generated summary files.

### Usage

To run the database viewer, execute the following command in your terminal:

```bash
shiny run db_viewer.py
```

This will launch a local web server, and you can access the viewer in your browser (usually at `http://127.0.0.1:8000`).

## PDF Merger (`pdf_merger.py`)

This utility script combines the newest `COR_Movers` PDF and `summary_B` PDF into a single file.

### Usage

The script is called automatically at the end of the `app.py` run. You can also run it manually:

```bash
python pdf_merger.py
```

## Google Drive Uploader (`gdrive_uploader.py`)

This utility script uploads one or more files or directories to a specified Google Drive folder.

### Usage

```bash
python gdrive_uploader.py "Your Folder Name" /path/to/file_or_directory
```

To see the setup instructions, run:
```bash
python gdrive_uploader.py --setup
```

### Setup Instructions (OAuth 2.0)

To use this script, you need to enable the Google Drive API and create an OAuth 2.0 Client ID.

1.  **Enable the Google Drive API:**
    *   Go to the Google Cloud Console: https://console.cloud.google.com/
    *   Create a new project or select an existing one.
    *   In the navigation menu, go to "APIs & Services" > "Library".
    *   Search for "Google Drive API" and click "Enable".

2.  **Configure the OAuth Consent Screen:**
    *   In the navigation menu, go to "APIs & Services" > "OAuth consent screen".
    *   Choose "External" and click "Create".
    *   Fill in the required fields (App name, User support email, Developer contact information).
    *   Click "SAVE AND CONTINUE" through the Scopes and Test users sections.
    *   On the Summary page, click "BACK TO DASHBOARD" and then "PUBLISH APP" to make it available.

3.  **Create an OAuth 2.0 Client ID:**
    *   In the navigation menu, go to "APIs & Services" > "Credentials".
    *   Click "+ CREATE CREDENTIALS" > "OAuth client ID".
    *   For "Application type", select "Desktop app".
    *   Give the client ID a name (e.g., "gdrive-uploader-desktop").
    *   Click "CREATE".
    *   A window will appear with your client ID and secret. Click "DOWNLOAD JSON".
    *   **Rename the downloaded file to `credentials.json` and place it in the same directory as this script.**

4.  **First Run and Authentication:**
    *   The first time you run the script, it will open a web browser and ask you to log in to your Google account and grant permission to the script.
    *   After you grant permission, a `token.json` file will be created in the same directory. This file stores your authentication tokens, so you won't have to log in every time.

**IMPORTANT:** Do not share your `credentials.json` or `token.json` files with anyone.